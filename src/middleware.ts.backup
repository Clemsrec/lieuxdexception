/**
 * Middleware Next.js - i18n + Sécurité + Protection
 * 
 * Ce middleware gère :
 * - Détection automatique de la langue (Accept-Language header)
 * - Redirection vers /[locale]/...
 * - Headers de sécurité HTTP
 * - Protection routes admin/API avec authentification
 */

import createMiddleware from 'next-intl/middleware';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { locales, defaultLocale } from './i18n';
// Note: JWT verification désactivée dans middleware (incompatible Edge Runtime)
// Vérification JWT déplacée dans les API routes avec Node.js runtime
// import { verifyIdToken, isUserAdmin } from '@/lib/verify-token';
// import { checkRateLimit, createRateLimitResponse } from '@/lib/rate-limit';

/**
 * Routes protégées nécessitant une authentification
 */
const PROTECTED_ROUTES = ['/admin'];

/**
 * Routes API sensibles nécessitant une authentification
 */
const PROTECTED_API_ROUTES = ['/api/admin', '/api/venues/create', '/api/venues/update'];

/**
 * Middleware i18n next-intl
 * Détection automatique de langue et routing /[locale]/...
 */
const intlMiddleware = createMiddleware({
  locales,
  defaultLocale,
  localePrefix: 'always', // Toujours afficher /fr/, /en/, etc.
  localeDetection: true // Détection auto via Accept-Language header
});

/**
 * Middleware principal - i18n + Sécurité + Authentification
 */
export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  
  // 1. Bypass pour fichiers statiques et _next
  if (
    pathname.startsWith('/_next') ||
    pathname.startsWith('/static') ||
    pathname.match(/\.(jpg|jpeg|png|gif|svg|ico|webp|woff|woff2|ttf|eot)$/i)
  ) {
    return NextResponse.next();
  }
  
  // 2. Bypass i18n pour /api routes (pas de locale dans les API)
  if (pathname.startsWith('/api')) {
    const response = NextResponse.next();
    // Appliquer quand même les headers de sécurité (voir plus bas)
    applySecurityHeaders(response);
    
    // Protection API routes
    if (PROTECTED_API_ROUTES.some(route => pathname.startsWith(route))) {
      const authToken = request.cookies.get('auth-token');
      
      if (!authToken) {
        return NextResponse.json(
          { error: 'Authentification requise', code: 'UNAUTHORIZED' },
          { status: 401 }
        );
      }
      
      console.log(`[Security] ✅ Cookie auth présent (API): ${pathname}`);
    }
    
    return response;
  }
  
  // 3. Appliquer middleware i18n (détection langue + routing)
  const response = intlMiddleware(request);
  
  // ===========================================
  // HEADERS DE SÉCURITÉ HTTP
  // ===========================================
  
  /**
   * Content Security Policy (CSP)
   * Protège contre XSS, injections de scripts, etc.
   */
  response.headers.set(
    'Content-Security-Policy',
    [
      "default-src 'self'",
      "script-src 'self' 'unsafe-eval' 'unsafe-inline' https://www.googletagmanager.com",
      "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
      "font-src 'self' https://fonts.gstatic.com https://r2cdn.perplexity.ai",
      "img-src 'self' data: https: blob:",
      "connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebase.google.com wss://*.firebaseio.com",
      "frame-src 'self' https://*.firebaseapp.com",
      "object-src 'none'",
      "base-uri 'self'",
      "form-action 'self'",
      "frame-ancestors 'none'",
      "upgrade-insecure-requests"
    ].join('; ')
  );
  
  /**
   * X-Frame-Options
   * Protège contre le clickjacking
   */
  response.headers.set('X-Frame-Options', 'DENY');
  
  /**
   * X-Content-Type-Options
   * Empêche le MIME sniffing
   */
  response.headers.set('X-Content-Type-Options', 'nosniff');
  
  /**
   * X-XSS-Protection
   * Active la protection XSS du navigateur (legacy mais utile)
   */
  response.headers.set('X-XSS-Protection', '1; mode=block');
  
  /**
   * Referrer-Policy
   * Contrôle les informations envoyées dans le header Referer
   */
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  /**
   * Permissions-Policy
   * Contrôle l'accès aux fonctionnalités du navigateur
   */
  response.headers.set(
    'Permissions-Policy',
    'camera=(), microphone=(), geolocation=(), interest-cohort=()'
  );
  
  /**
   * Strict-Transport-Security (HSTS)
   * Force HTTPS pour toutes les requêtes futures
   * Note: Activé uniquement en production
   */
  if (process.env.NODE_ENV === 'production') {
    response.headers.set(
      'Strict-Transport-Security',
      'max-age=31536000; includeSubDomains; preload'
    );
  }
  
  // ===========================================
  // PROTECTION DES ROUTES ADMIN
  // ===========================================
  
  if (PROTECTED_ROUTES.some(route => pathname.startsWith(route))) {
    console.log(`[Security] Accès route protégée: ${pathname}`);
    
    // Vérification du cookie d'authentification
    const authToken = request.cookies.get('auth-token');
    
    if (!authToken) {
      // Extraire locale du pathname pour redirection
      const locale = pathname.split('/')[1] || defaultLocale;
      const loginUrl = new URL(`/${locale}/admin/connexion`, request.url);
      loginUrl.searchParams.set('redirect', pathname);
      return NextResponse.redirect(loginUrl);
    }
    
    // TODO: Vérification JWT déplacée dans les API routes (Node.js runtime)
    console.log(`[Security] ✅ Cookie auth présent: ${pathname}`);
  }
  
  return response;
}

/**
 * Applique les headers de sécurité HTTP sur une réponse
 */
function applySecurityHeaders(response: NextResponse) {
  /**
   * Content Security Policy (CSP)
   * Protège contre XSS, injections de scripts, etc.
   */
  response.headers.set(
    'Content-Security-Policy',
    [
      "default-src 'self'",
      "script-src 'self' 'unsafe-eval' 'unsafe-inline' https://www.googletagmanager.com",
      "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
      "font-src 'self' https://fonts.gstatic.com https://r2cdn.perplexity.ai",
      "img-src 'self' data: https: blob:",
      "connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebase.google.com wss://*.firebaseio.com",
      "frame-src 'self' https://*.firebaseapp.com",
      "object-src 'none'",
      "base-uri 'self'",
      "form-action 'self'",
      "frame-ancestors 'none'",
      "upgrade-insecure-requests"
    ].join('; ')
  );
  
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-XSS-Protection', '1; mode=block');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  response.headers.set('Permissions-Policy', 'camera=(), microphone=(), geolocation=(), interest-cohort=()');
  
  if (process.env.NODE_ENV === 'production') {
    response.headers.set('Strict-Transport-Security', 'max-age=31536000; includeSubDomains; preload');
  }
}

/**
 * Configuration du matcher
 * Applique middleware i18n + sécurité sur toutes les routes sauf fichiers statiques
 */
export const config = {
  matcher: [
    // Match toutes les routes pour i18n sauf fichiers statiques et API
    '/((?!api|_next|static|.*\\..*|favicon.ico|robots.txt|sitemap.xml).*)',
    // Ajouter /api explicitement pour les headers de sécurité
    '/api/:path*'
  ],
};
