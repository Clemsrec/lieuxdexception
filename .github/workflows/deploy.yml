# Workflow GitHub Actions - D√©ploiement Firebase App Hosting
# D√©ploiement automatique sur push sur main avec secrets s√©curis√©s

name: Deploy to Firebase App Hosting

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '20'
  PROJECT_ID: 'lieux-d-exceptions'

jobs:
  # Job 1: Tests et Validation
  test:
    name: Tests et Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Installation des d√©pendances
        run: npm ci
      
      - name: üîç Linting
        run: npm run lint
      
      - name: üèóÔ∏è Build de test
        run: npm run build
        env:
          # Variables publiques pour le build
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: lieux-d-exceptions.firebaseapp.com
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: lieux-d-exceptions
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: lieux-d-exceptions.appspot.com
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "886228169873"
          NEXT_PUBLIC_FIREBASE_APP_ID: 1:886228169873:web:154416b7ee0e74b70cfb30
          NEXT_PUBLIC_FIREBASE_DATABASE_ID: lieuxdexception
          # Secrets depuis GitHub Secrets
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
      
      - name: ‚úÖ Tests (si configur√©s)
        run: npm run test --if-present
        continue-on-error: true

  # Job 2: D√©ploiement sur Firebase (uniquement sur main)
  deploy:
    name: D√©ploiement Firebase
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      id-token: write  # N√©cessaire pour l'authentification Workload Identity
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Installation des d√©pendances
        run: npm ci
      
      - name: üîê Authentification Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - name: ‚òÅÔ∏è Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      - name: üèóÔ∏è Build de production
        run: npm run build
        env:
          # Variables publiques
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: lieux-d-exceptions.firebaseapp.com
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: lieux-d-exceptions
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: lieux-d-exceptions.appspot.com
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "886228169873"
          NEXT_PUBLIC_FIREBASE_APP_ID: 1:886228169873:web:154416b7ee0e74b70cfb30
          NEXT_PUBLIC_FIREBASE_DATABASE_ID: lieuxdexception
          NEXT_PUBLIC_APP_URL: https://lieux-d-exceptions.web.app
          NODE_ENV: production
          # Secrets depuis GitHub Secrets
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
      
      - name: üöÄ D√©ploiement Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ env.PROJECT_ID }}
      
      - name: üìä Notification de succ√®s
        if: success()
        run: |
          echo "‚úÖ D√©ploiement r√©ussi !"
          echo "üåê URL: https://lieux-d-exceptions.web.app"
      
      - name: ‚ùå Notification d'√©chec
        if: failure()
        run: |
          echo "‚ùå Le d√©ploiement a √©chou√©"
          echo "üìã V√©rifiez les logs ci-dessus pour plus de d√©tails"

  # Job 3: Preview Deployment (pour les PRs)
  preview:
    name: Preview Deployment
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Installation des d√©pendances
        run: npm ci
      
      - name: üèóÔ∏è Build preview
        run: npm run build
        env:
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: lieux-d-exceptions.firebaseapp.com
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: lieux-d-exceptions
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: lieux-d-exceptions.appspot.com
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "886228169873"
          NEXT_PUBLIC_FIREBASE_APP_ID: 1:886228169873:web:154416b7ee0e74b70cfb30
          NEXT_PUBLIC_FIREBASE_DATABASE_ID: lieuxdexception
          NODE_ENV: production
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
      
      - name: üîç D√©ploiement Preview
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ env.PROJECT_ID }}
          # Pas de channelId = preview automatique
